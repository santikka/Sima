<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diabetes and stroke example • Sima</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Diabetes and stroke example">
<meta property="og:description" content="An example use case of the simulation framework for modeling the incidence  of diabetes and stroke, and mortality with interventions
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Sima</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/Sima.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/DiabetesAndStroke.html">Diabetes and stroke example</a>
    </li>
    <li>
      <a href="../articles/SickSickerModel.html">Sick-sicker model</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/santikk/Sima/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="DiabetesAndStroke_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Diabetes and stroke example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/santikk/Sima/blob/master/vignettes/DiabetesAndStroke.Rmd"><code>vignettes/DiabetesAndStroke.Rmd</code></a></small>
      <div class="hidden name"><code>DiabetesAndStroke.Rmd</code></div>

    </div>

    
    
<p>In this example we consider a simulator for the incidence of type-2 diabetes and stroke with various risk factors as well as mortality from stroke and other causes. Interventions that aim to reduce systolic blood pressure in the population are also considered</p>
<div id="data-files" class="section level2">
<h2 class="hasAnchor">
<a href="#data-files" class="anchor"></a>Data files</h2>
<p>To run the example, the following data files are needed</p>
<ul>
<li>The Finnish WHO MONICA data: <a href="http://www.thl.fi/publications/monica/monograph_cd/data/form04_3.zip" class="uri">http://www.thl.fi/publications/monica/monograph_cd/data/form04_3.zip</a>
</li>
<li>Finnish mortality statistics from Statistics Finland for the year 2017. The material was downloaded from Statistics Finland’s interface service on 10 May 2020 with the license <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a>: <a href="http://users.jyu.fi/~santikka/Sima/data/kuol_007_201700.csv" class="uri">http://users.jyu.fi/~santikka/Sima/data/kuol_007_201700.csv</a>
</li>
<li>Finnish age structure statistics from Statistics Finland for the year 2017. The material was downloaded from Statistics Finland’s interface service on 11 May 2020 with the license <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a>: <a href="http://users.jyu.fi/~santikka/Sima/data/vaesto_3112_2017.csv" class="uri">http://users.jyu.fi/~santikka/Sima/data/vaesto_3112_2017.csv</a>
</li>
</ul>
<p>The data files (with MONICA data unzipped) should be placed to directory called <code>data</code> in relation to the working directory for the purposes of this example.</p>
</div>
<div id="r-scripts" class="section level2">
<h2 class="hasAnchor">
<a href="#r-scripts" class="anchor"></a>R scripts</h2>
<p>The R script files required to run the example can be downloaded at <a href="http://users.jyu.fi/~santikka/Sima/diabetes_and_stroke.zip" class="uri">http://users.jyu.fi/~santikka/Sima/diabetes_and_stroke.zip</a></p>
<p>The zip file contains the following</p>
<ul>
<li>
<code>diabetes_and_stroke.R</code> is the primary script that contains the all the simulator definition and simulation runs.</li>
<li>
<code>events.R</code> contains all the event definitions.</li>
<li>
<code>data.R</code> contains the function to generate the initial population.</li>
<li>
<code>functions.R</code> contains utility function definitions that are used throughout.</li>
</ul>
<p>The contents of these scripts are also listed in the following sections for direct viewing</p>
</div>
<div id="main-script" class="section level2">
<h2 class="hasAnchor">
<a href="#main-script" class="anchor"></a>Main script</h2>
<p>The file <code>diabetes_and_stroke.R</code> provides the code to run the entire example</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## An example use case of the Sima framework constructing a simulator for </span>
<span class="co">## modelling interventions regarding salt use in a synthetic population with </span>
<span class="co">## Finnish population characteristics in the year 2017. Also includes</span>
<span class="co">## interventions that aim to reduce systolic blood pressure in the population.</span>

<span class="co"># Uncomment to install packages</span>
<span class="co"># install.packages(c("data.table", "ggplot2", "bestNormalize", "devtools"))</span>
<span class="co"># devtools::install_github("santikka/Sima")</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://santikk.github.io/Sima">Sima</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># The file_path should be set to the location of the R-scripts, such that</span>
<span class="co"># the data-directory is present in this location</span>

<span class="co"># file_path &lt;- ""</span>
<span class="co"># setwd(file_path)</span>

<span class="co"># Verify that all data files are available</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">"data/vaesto_3112_2017.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Data file vaesto_3112_2017.csv not found in data directory."</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">"data/kuol_007_201700.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Data file kuol_007_201700 not found in data directory."</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">"data/form04_3.txt"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Data file form04_3.txt not found in data directory."</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#####################</span>
<span class="co"># Utility Functions #</span>
<span class="co">#####################</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"functions.R"</span><span class="op">)</span>

<span class="co">##########</span>
<span class="co"># Events #</span>
<span class="co">##########</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"events.R"</span><span class="op">)</span>

<span class="co">######################</span>
<span class="co"># Initial Population #</span>
<span class="co">######################</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"data.R"</span><span class="op">)</span>

<span class="co">##################</span>
<span class="co"># Initialization #</span>
<span class="co">##################</span>

<span class="co"># Main simulator, set n to desired population size</span>
<span class="va">sim</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Simulator.html">Simulator</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    initializer <span class="op">=</span> <span class="va">initializer</span>,
    man_events <span class="op">=</span> <span class="va">all_events</span>,
    seeds <span class="op">=</span> <span class="fl">242</span>,
    keep_init <span class="op">=</span> <span class="cn">TRUE</span>,
    n <span class="op">=</span> <span class="fl">3.6e6</span>
<span class="op">)</span>

<span class="co">########################</span>
<span class="co"># Parallel computation #</span>
<span class="co">########################</span>

<span class="co">## Uncomment to enable a parallel cluster for remaining computations</span>
<span class="co"># if (require(doParallel)) {</span>
<span class="co">#     nc &lt;- parallel::detectCores()</span>
<span class="co">#     cl &lt;- parallel::makeCluster(nc)</span>
<span class="co">#     doParallel::registerDoParallel(cl)</span>
<span class="co">#     ## User made functions/objects have to be manually exported, list them in 'export'</span>
<span class="co">#     sim$start_cluster(cl, nc, export = c("logit", "expit", "rbern", "rbern2"))</span>
<span class="co"># }</span>

<span class="co">###############</span>
<span class="co"># Calibration #</span>
<span class="co">###############</span>

<span class="co"># Uncomment to perform calibration</span>
<span class="co"># calib_result &lt;- optim(par = sqrt(c(13.51056, 161.12780, 5.41859)), </span>
<span class="co">#                       fn = mortality_objective, </span>
<span class="co">#                       method = "Nelder-Mead", </span>
<span class="co">#                       calib_sim = sim)</span>

<span class="co"># Using a population of 1 million individuals, the following optimum is found:</span>
<span class="co"># c(12.03600, 171.32261, 12.52546)</span>

<span class="co"># Configure the simulator to use the optimal parameters </span>
<span class="co"># Here, only 1st parameter is configured for stroke mortality</span>
<span class="va">sim</span><span class="op">$</span><span class="fu">reconfigure</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"Other Mortality"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">12.03600</span>, scale <span class="op">=</span> <span class="fl">171.32261</span><span class="op">)</span>, 
    <span class="st">"Stroke Mortality"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fl">12.52546</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># Visualize and compare simulated mortality to official statistics</span>
<span class="va">sim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">364</span><span class="op">)</span>
<span class="va">sim</span><span class="op">$</span><span class="fu">stop_cluster</span><span class="op">(</span><span class="op">)</span>

<span class="va">mortality</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data/kuol_007_201700.csv"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span>
<span class="va">mortality</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mortality</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">/</span><span class="fl">1000</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mortality</span><span class="op">)</span>
<span class="va">mortality</span> <span class="op">&lt;-</span> <span class="va">mortality</span><span class="op">[</span><span class="va">mortality</span><span class="op">$</span><span class="va">Age</span> <span class="op">&gt;=</span> <span class="fl">31</span>,<span class="op">]</span>
<span class="va">mortality_sim</span> <span class="op">&lt;-</span> <span class="fu">mortality_df</span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="fu">get_status</span><span class="op">(</span><span class="op">)</span>, min_age <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">$</span><span class="va">out</span>

<span class="va">out_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">mortality_sim</span><span class="op">$</span><span class="va">age_group</span>, <span class="fl">2</span><span class="op">)</span>,
    mortality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mortality_sim</span><span class="op">$</span><span class="va">deaths</span><span class="op">/</span><span class="va">mortality_sim</span><span class="op">$</span><span class="va">size</span>, <span class="va">mortality</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>,
    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/gl.html">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mortality</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Simulated"</span>, <span class="st">"Reported"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Plot comparing mortality in the synthetic population to the official statistics</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">out_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">mortality</span>, linetype <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
        legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.190</span>, <span class="fl">0.85</span><span class="op">)</span>,
        legend.key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1.75</span>, <span class="st">"cm"</span><span class="op">)</span>,
        legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="st">"line"</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,
        plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5.5</span>, <span class="fl">12</span>, <span class="fl">5.5</span>, <span class="fl">5.5</span><span class="op">)</span>, <span class="st">"points"</span><span class="op">)</span>,
        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">2</span>, linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">100</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">10</span> <span class="op">*</span> <span class="fl">10</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.4</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"longdash"</span>, <span class="st">"solid"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Mortality"</span>, title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="va">g</span>

<span class="co">######################</span>
<span class="co"># Selective sampling #</span>
<span class="co">######################</span>

<span class="co"># Create a study population corresponding to the target sample </span>
<span class="va">sim_sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Simulator.html">Simulator</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    initializer <span class="op">=</span> <span class="va">initializer</span>,
    man_events <span class="op">=</span> <span class="va">all_events</span>,
    keep_init <span class="op">=</span> <span class="cn">TRUE</span>,
    seeds <span class="op">=</span> <span class="fl">242</span>,
    n <span class="op">=</span> <span class="fl">3.6e6</span>
<span class="op">)</span>

<span class="co"># Configure the simulator to use the optimal parameters</span>
<span class="co"># Here, only 1st parameter is configured for stroke mortality</span>
<span class="va">sim_sample</span><span class="op">$</span><span class="fu">reconfigure</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"Other Mortality"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">12.03600</span>, scale <span class="op">=</span> <span class="fl">171.32261</span><span class="op">)</span>, 
    <span class="st">"Stroke Mortality"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fl">12.52546</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="va">missingness</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">9.484330</span>, <span class="op">-</span><span class="fl">0.311690</span>, <span class="fl">0.113614</span>, <span class="op">-</span><span class="fl">0.090696</span>, <span class="fl">0.036383</span>, <span class="fl">0.689770</span><span class="op">)</span>
    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span> ,<span class="fu">.</span><span class="op">(</span>const <span class="op">=</span> <span class="fl">1</span>, <span class="va">sex</span>, <span class="va">age</span>, <span class="va">bmi</span>, <span class="va">waist_circumference</span>, <span class="va">smoking</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    <span class="fu">rbern</span><span class="op">(</span><span class="fu">expit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">X</span> <span class="op">%*%</span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">sim_sample</span><span class="op">$</span><span class="fu">get_status</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1e4</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">)</span>
<span class="va">baseline_sample</span> <span class="op">&lt;-</span> <span class="va">pop</span><span class="op">$</span><span class="va">id</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">m</span>, <span class="va">m</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">baseline_nonresp</span> <span class="op">&lt;-</span> <span class="fu">missingness</span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="va">baseline_sample</span>,<span class="op">]</span><span class="op">)</span>
<span class="va">baseline_stroke</span> <span class="op">&lt;-</span> <span class="va">pop</span><span class="op">[</span><span class="va">baseline_sample</span>,<span class="va">stroke</span><span class="op">]</span>

<span class="co">## Uncomment to enable a parallel cluster for remaining computations</span>
<span class="co"># if (require(doParallel)) {</span>
<span class="co">#     nc &lt;- parallel::detectCores()</span>
<span class="co">#     cl &lt;- parallel::makeCluster(nc)</span>
<span class="co">#     doParallel::registerDoParallel(cl)</span>
<span class="co">#     ## User made functions/objects have to be manually exported, list them in 'export'</span>
<span class="co">#     sim_sample$start_cluster(cl, nc, export = c("logit", "expit", "rbern", "rbern2"))</span>
<span class="co"># }</span>

<span class="va">sim_sample</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">10</span> <span class="op">*</span> <span class="fl">365</span><span class="op">)</span>
<span class="va">sim_sample</span><span class="op">$</span><span class="fu">stop_cluster</span><span class="op">(</span><span class="op">)</span>

<span class="co"># Update stroke status after 10 years</span>
<span class="va">pop_10y</span> <span class="op">&lt;-</span> <span class="va">sim_sample</span><span class="op">$</span><span class="fu">get_status</span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">pop</span><span class="op">[</span><span class="va">baseline_sample</span>, <span class="va">stroke</span> <span class="op">:=</span> <span class="va">pop_10y</span><span class="op">[</span><span class="va">baseline_sample</span>,<span class="va">stroke</span><span class="op">]</span><span class="op">]</span>

<span class="co"># Comparing two subsets: one with dropout (miss), one without (full)</span>
<span class="co"># (and one with the entire population, if included, otherwise same as full)</span>
<span class="va">included_miss</span> <span class="op">&lt;-</span> <span class="va">baseline_sample</span> <span class="op">&amp;</span> <span class="va">baseline_nonresp</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">baseline_stroke</span> <span class="op">==</span> <span class="fl">0</span>
<span class="va">included_full</span> <span class="op">&lt;-</span> <span class="va">baseline_sample</span> <span class="op">&amp;</span> <span class="va">baseline_stroke</span> <span class="op">==</span> <span class="fl">0</span>

<span class="co"># Separate models for men and women</span>
<span class="va">model_miss_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">stroke</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">smoking</span> <span class="op">+</span> <span class="va">blood_pressure</span> <span class="op">+</span> <span class="va">hdl_cholesterol</span> <span class="op">+</span> 
                        <span class="va">diabetes</span> <span class="op">+</span> <span class="va">parent_stroke</span>, 
                    data <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="va">included_miss</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">model_miss_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">stroke</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">smoking</span> <span class="op">+</span> <span class="va">blood_pressure</span> <span class="op">+</span> <span class="va">hdl_cholesterol</span> <span class="op">+</span> 
                        <span class="va">diabetes</span> <span class="op">+</span> <span class="va">parent_stroke</span>, 
                    data <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="va">included_miss</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">model_full_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">stroke</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">smoking</span> <span class="op">+</span> <span class="va">blood_pressure</span> <span class="op">+</span> <span class="va">hdl_cholesterol</span> <span class="op">+</span> 
                        <span class="va">diabetes</span> <span class="op">+</span> <span class="va">parent_stroke</span>, 
                    data <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="va">included_full</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">model_full_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">stroke</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">smoking</span> <span class="op">+</span> <span class="va">blood_pressure</span> <span class="op">+</span> <span class="va">hdl_cholesterol</span> <span class="op">+</span> 
                        <span class="va">diabetes</span> <span class="op">+</span> <span class="va">parent_stroke</span>, 
                    data <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="va">included_full</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># model_pop_m &lt;- glm(stroke ~ age + smoking + blood_pressure + hdl_cholesterol + </span>
<span class="co">#                       diabetes + parent_stroke, </span>
<span class="co">#                    data = pop[included_pop &amp; sex == 0, ], family = binomial())</span>
<span class="co"># model_pop_f &lt;- glm(stroke ~ age + smoking + blood_pressure + hdl_cholesterol + </span>
<span class="co">#                       diabetes + parent_stroke, </span>
<span class="co">#                    data = pop[included_pop &amp; sex == 1, ], family = binomial())</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_miss_m</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_miss_f</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_full_m</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_full_f</span><span class="op">)</span>
<span class="co"># summary(model_pop_f)</span>
<span class="co"># summary(model_pop_m)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_miss_m</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_miss_f</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_full_m</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model_full_f</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co"># round(exp(coef(model_pop_m)), 2)</span>
<span class="co"># round(exp(coef(model_pop_f)), 2)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">model_miss_m</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">model_miss_f</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">model_full_m</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">model_full_f</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co"># round(exp(confint(model_pop_m)), 2)</span>
<span class="co"># round(exp(confint(model_pop_f)), 2)</span>

<span class="co">#################</span>
<span class="co"># Interventions #</span>
<span class="co">#################</span>

<span class="co"># Set the interventions for each scenario</span>
<span class="co"># the events 'industry_salt' and 'doctor_advice' are defined in events.R</span>
<span class="va">interventions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># No intervention, baseline</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">industry_salt</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">doctor_advice</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define the relevant parameters for each scenario</span>
<span class="va">intervention_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>effect <span class="op">=</span> <span class="fl">0.97</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        adherence <span class="op">=</span> <span class="fl">0.5</span>,
        effect <span class="op">=</span> <span class="op">-</span><span class="fl">2.0</span>
    <span class="op">)</span>
<span class="op">)</span>

<span class="co"># Apply each scenario and record the results</span>
<span class="co"># -- N : simulation time for each scenario</span>
<span class="co"># -- M : number of replications for each scenario</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">*</span> <span class="fl">365</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">interventions</span><span class="op">)</span>
<span class="va">init_stroke</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="fu">get_status</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">stroke</span><span class="op">)</span>
<span class="va">new_stroke</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">M</span>, <span class="va">I</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">I</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">sim</span><span class="op">$</span><span class="fu">reset</span><span class="op">(</span>seeds <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">m</span> <span class="op">+</span> <span class="va">i</span><span class="op">)</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">interventions</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">interventions</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">set_parameters</span><span class="op">(</span><span class="va">intervention_pars</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
            <span class="va">sim</span><span class="op">$</span><span class="fu">intervene</span><span class="op">(</span>man_events <span class="op">=</span> <span class="va">interventions</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
        <span class="op">}</span>
        <span class="va">sim</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">N</span>, show_progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
        <span class="va">new_stroke</span><span class="op">[</span><span class="va">m</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="fu">get_status</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">stroke</span><span class="op">)</span> <span class="op">-</span> <span class="va">init_stroke</span>
    <span class="op">}</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="events" class="section level2">
<h2 class="hasAnchor">
<a href="#events" class="anchor"></a>Events</h2>
<p>The file <code>events.R</code> includes the event definitions</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#####################</span>
<span class="co"># Event definitions #</span>
<span class="co">#####################</span>

<span class="va">aging</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Aging"</span>,
    description <span class="op">=</span> <span class="st">"Normal aging of individuals"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        day <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="fl">365.0</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span>, <span class="va">age</span> <span class="op">:=</span> <span class="va">age</span> <span class="op">+</span> <span class="va">day</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">other_mortality</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Other Mortality"</span>,
    description <span class="op">=</span> <span class="st">"Risk of death when no stroke has occurred"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        shape <span class="op">=</span> <span class="fl">13.16346</span>, 
        scale <span class="op">=</span> <span class="fl">165.34514</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">u</span> <span class="op">&lt;-</span>  <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">0L</span>, <span class="fu">rbern</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html">pweibull</a></span><span class="op">(</span><span class="va">age</span>, shape <span class="op">=</span> <span class="va">shape</span>, scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
        <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">0L</span>, <span class="fu">`:=`</span> <span class="op">(</span>alive <span class="op">=</span> <span class="va">u</span>, cause_of_death <span class="op">=</span> <span class="fl">1L</span> <span class="op">-</span> <span class="va">u</span><span class="op">)</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">get_stroke</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Stroke"</span>,
    description <span class="op">=</span> <span class="st">"Risk of suffering a stroke"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                        <span class="co"># const  age    smoking  bp        hdl     diab.   parents' stroke</span>
        beta_male   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">11.699</span>, <span class="fl">0.1153</span>, <span class="fl">0.4981</span>, <span class="fl">0.0149</span>,  <span class="op">-</span><span class="fl">0.4406</span>, <span class="fl">0.879</span>,  <span class="fl">0.2933</span><span class="op">)</span>,
        beta_female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">7.966</span>,  <span class="fl">0.0633</span>, <span class="fl">0.4163</span>, <span class="fl">0.00893</span>, <span class="op">-</span><span class="fl">0.7636</span>, <span class="fl">1.2383</span>, <span class="fl">0.5470</span><span class="op">)</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">subset_male</span>   <span class="op">&lt;-</span> <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">0L</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span>, which <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>
        <span class="va">subset_female</span> <span class="op">&lt;-</span> <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">0L</span> <span class="op">&amp;</span> <span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span>, which <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>
        <span class="va">X_male</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">status</span><span class="op">[</span><span class="va">subset_male</span>,   
            <span class="fu">.</span><span class="op">(</span>const <span class="op">=</span> <span class="fl">1</span>, <span class="va">age</span>, <span class="va">smoking</span>, <span class="va">blood_pressure</span>, <span class="va">hdl_cholesterol</span>, <span class="va">diabetes</span>, <span class="va">parent_stroke</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
        <span class="va">X_female</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">status</span><span class="op">[</span><span class="va">subset_female</span>, 
            <span class="fu">.</span><span class="op">(</span>const <span class="op">=</span> <span class="fl">1</span>, <span class="va">age</span>, <span class="va">smoking</span>, <span class="va">blood_pressure</span>, <span class="va">hdl_cholesterol</span>, <span class="va">diabetes</span>, <span class="va">parent_stroke</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

        <span class="co"># Compute 1 day risk from 10 year risk by assuming a Poisson process.</span>
        <span class="va">prob_male_10year</span>   <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fu">expit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">X_male</span> <span class="op">%*%</span> <span class="va">beta_male</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
        <span class="va">prob_female_10year</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fu">expit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">X_female</span> <span class="op">%*%</span> <span class="va">beta_female</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
        <span class="va">lambda_male</span>   <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">prob_male_10year</span>, <span class="fl">1e-12</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3650.0</span>
        <span class="va">lambda_female</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">prob_female_10year</span>, <span class="fl">1e-12</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3650.0</span>
        <span class="va">new_stroke_male</span>   <span class="op">&lt;-</span> <span class="fu">rbern</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda_male</span><span class="op">)</span><span class="op">)</span>
        <span class="va">new_stroke_female</span> <span class="op">&lt;-</span> <span class="fu">rbern</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda_female</span><span class="op">)</span><span class="op">)</span>

        <span class="co"># Assign dates for stroke occurrence, update stroke status</span>
        <span class="va">status</span><span class="op">[</span><span class="va">subset_male</span>,   <span class="fu">`:=`</span> <span class="op">(</span>age_at_stroke <span class="op">=</span> <span class="va">age</span> <span class="op">*</span> <span class="va">new_stroke_male</span>,   stroke <span class="op">=</span> <span class="va">new_stroke_male</span><span class="op">)</span><span class="op">]</span>
        <span class="va">status</span><span class="op">[</span><span class="va">subset_female</span>, <span class="fu">`:=`</span> <span class="op">(</span>age_at_stroke <span class="op">=</span> <span class="va">age</span> <span class="op">*</span> <span class="va">new_stroke_female</span>, stroke <span class="op">=</span> <span class="va">new_stroke_female</span><span class="op">)</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">get_diabetes</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Diabetes"</span>,
    description <span class="op">=</span> <span class="st">"Risk of getting diabetes"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                <span class="co"># const   age(45-54) age(55-64) bmi(25-30) bmi(&gt;30) w. circ. (1) w.circ. (2) h. glucose</span>
        beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5.514</span>,  <span class="fl">0.628</span>,     <span class="fl">0.892</span>,     <span class="fl">0.165</span>,     <span class="fl">1.096</span>,   <span class="fl">0.857</span>,       <span class="fl">1.350</span>,      <span class="fl">2.139</span><span class="op">)</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">subset</span> <span class="op">&lt;-</span> <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">diabetes</span> <span class="op">==</span> <span class="fl">0L</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">45</span>, which <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>
        <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">status</span><span class="op">[</span><span class="va">subset</span>, <span class="fu">.</span><span class="op">(</span>
            const <span class="op">=</span> <span class="fl">1</span>,
            age1 <span class="op">=</span> <span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">45</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;</span> <span class="fl">54</span><span class="op">)</span>, 
            age2 <span class="op">=</span> <span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">54</span><span class="op">)</span>, 
            bmi1 <span class="op">=</span> <span class="op">(</span><span class="va">bmi</span> <span class="op">&gt;</span> <span class="fl">25</span> <span class="op">&amp;</span> <span class="va">bmi</span> <span class="op">&lt;=</span> <span class="fl">30</span><span class="op">)</span>, 
            bmi2 <span class="op">=</span> <span class="op">(</span><span class="va">bmi</span> <span class="op">&gt;</span> <span class="fl">30</span><span class="op">)</span>, 
            waist_circumference1 <span class="op">=</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">94</span> <span class="op">&amp;</span> <span class="va">waist_circumference</span> <span class="op">&lt;</span> <span class="fl">102</span><span class="op">)</span> <span class="op">+</span>
                                   <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">80</span> <span class="op">&amp;</span> <span class="va">waist_circumference</span> <span class="op">&lt;</span> <span class="fl">88</span><span class="op">)</span>,
            waist_circumference2 <span class="op">=</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">102</span><span class="op">)</span> <span class="op">+</span> 
                                   <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">88</span><span class="op">)</span>,
            <span class="va">high_glucose</span><span class="op">)</span>
        <span class="op">]</span><span class="op">)</span>

        <span class="co"># Compute 1 day risk from 10 year risk by assuming a Poisson process.</span>
        <span class="va">prob_10year</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fu">expit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op">%*%</span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
        <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">prob_10year</span>, <span class="fl">1e-12</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3650.0</span>
        <span class="va">new_diabetes</span> <span class="op">&lt;-</span> <span class="fu">rbern</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span>

        <span class="co"># Update diabetes status</span>
        <span class="va">status</span><span class="op">[</span><span class="va">subset</span>, <span class="va">diabetes</span> <span class="op">:=</span> <span class="va">new_diabetes</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">stroke_mortality</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Stroke Mortality"</span>,
    description <span class="op">=</span> <span class="st">"Risk of death after suffering a stroke"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        initial <span class="op">=</span> <span class="fl">5.41859</span>, 
        longterm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8.17473693</span>, <span class="op">-</span><span class="fl">2.47553590</span>, <span class="op">-</span><span class="fl">0.01651868</span><span class="op">)</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">u</span> <span class="op">&lt;-</span> <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">1L</span>, <span class="fu">rbern</span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">fifelse</a></span><span class="op">(</span>
            <span class="va">age</span> <span class="op">-</span> <span class="va">age_at_stroke</span> <span class="op">&lt;</span> <span class="op">(</span><span class="fl">28.0</span> <span class="op">/</span> <span class="fl">365.0</span><span class="op">)</span>, 
            <span class="va">initial</span>, 
            <span class="fu">expit</span><span class="op">(</span><span class="va">longterm</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">longterm</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="va">age_at_stroke</span><span class="op">)</span> <span class="op">*</span> <span class="fl">365</span> <span class="op">-</span> <span class="fl">27</span><span class="op">)</span> <span class="op">*</span> <span class="va">longterm</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
        <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">1L</span>, <span class="fu">`:=`</span> <span class="op">(</span>alive <span class="op">=</span> <span class="va">u</span>, cause_of_death <span class="op">=</span> <span class="fl">2L</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1L</span> <span class="op">-</span> <span class="va">u</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">industry_salt</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Intervention 1"</span>,
    description <span class="op">=</span> <span class="st">"Industry reduces salt content in all products"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        effect <span class="op">=</span> <span class="op">-</span><span class="fl">0.97</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span>, <span class="va">blood_pressure</span> <span class="op">:=</span> <span class="va">blood_pressure</span> <span class="op">+</span> <span class="va">effect</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">doctor_advice</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ManipulationEvent.html">ManipulationEvent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">"Intervention 2"</span>,
    description <span class="op">=</span> <span class="st">"Advice to stop adding salt in cooking and at table"</span>,
    parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        adherence <span class="op">=</span> <span class="fl">0.5</span>,
        effect <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>
    <span class="op">)</span>,
    mechanism <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">{</span>
        <span class="va">status</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">1L</span> <span class="op">&amp;</span> <span class="va">blood_pressure</span> <span class="op">&gt;=</span> <span class="fl">140</span>, 
               <span class="va">blood_pressure</span> <span class="op">:=</span> <span class="va">blood_pressure</span> <span class="op">+</span> <span class="va">effect</span> <span class="op">*</span> <span class="fu">rbern2</span><span class="op">(</span><span class="va">.N</span>, <span class="va">adherence</span><span class="op">)</span><span class="op">]</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Further event organizing</span>
<span class="va">stroke_events</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">stroke_mortality</span>, <span class="va">get_stroke</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">stroke_events</span>, <span class="st">"ordered"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
<span class="va">other_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">stroke_events</span>, <span class="va">other_mortality</span>, <span class="va">get_diabetes</span><span class="op">)</span>
<span class="va">all_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">aging</span>, <span class="va">other_events</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">all_events</span>, <span class="st">"ordered"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></code></pre></div>
</div>
<div id="initial-population" class="section level2">
<h2 class="hasAnchor">
<a href="#initial-population" class="anchor"></a>Initial population</h2>
<p>The file <code>data.R</code> contains the following function for generating the initial population (of size <code>n</code>)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">initializer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Seed for initial data generation</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
    <span class="fu">dqrng</span><span class="fu">::</span><span class="fu"><a href="https://daqana.github.io/dqrng/reference/dqrng-functions.html">dqset.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
    <span class="va">widths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">6</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">8</span>,<span class="fl">8</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,
                <span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">8</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">8</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span><span class="op">)</span>
    <span class="va">colnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"form"</span>,<span class="st">"versn"</span>,<span class="st">"centre"</span>,<span class="st">"runit"</span>,<span class="st">"serial"</span>,<span class="st">"numsur"</span>,<span class="st">"samunit"</span>,<span class="st">"dexam"</span>,<span class="st">"mbirth"</span>,
                  <span class="st">"agegr"</span>,<span class="st">"sex"</span>,<span class="st">"marit"</span>,<span class="st">"edlevel"</span>,<span class="st">"school"</span>,<span class="st">"cigs"</span>,<span class="st">"numcigs"</span>,<span class="st">"daycigs"</span>,<span class="st">"evercig"</span>,
                  <span class="st">"stop"</span>,<span class="st">"iflyear"</span>,<span class="st">"maxcigs"</span>,<span class="st">"cigage"</span>,<span class="st">"cigarsm"</span>,<span class="st">"cigar"</span>,<span class="st">"pipesm"</span>,<span class="st">"pipe"</span>,<span class="st">"othersm"</span>,
                  <span class="st">"hibp"</span>,<span class="st">"drugs"</span>,<span class="st">"bprecd"</span>,<span class="st">"hich"</span>,<span class="st">"chdt"</span>,<span class="st">"chrx"</span>,<span class="st">"chrecd"</span>,<span class="st">"asp"</span>,<span class="st">"menop"</span>,<span class="st">"agem"</span>,
                  <span class="st">"horm"</span>,<span class="st">"pill"</span>,<span class="st">"syst1"</span>,<span class="st">"diast1"</span>,<span class="st">"rz1"</span>,<span class="st">"syst2"</span>,<span class="st">"diast2"</span>,<span class="st">"rz2"</span>,<span class="st">"cuff"</span>,<span class="st">"arm"</span>,
                  <span class="st">"bpcoder"</span>,<span class="st">"timebp"</span>,<span class="st">"rtemp"</span>,<span class="st">"chol"</span>,<span class="st">"choldl"</span>,<span class="st">"dchol"</span>,<span class="st">"hdl"</span>,<span class="st">"hdldl"</span>,<span class="st">"dhdl"</span>,<span class="st">"scn"</span>,
                  <span class="st">"cotin"</span>,<span class="st">"carbmon"</span>,<span class="st">"height"</span>,<span class="st">"weight"</span>,<span class="st">"waist"</span>,<span class="st">"hip"</span>,<span class="st">"whcoder"</span>,<span class="st">"oversion"</span>,<span class="st">"eage"</span>,
                  <span class="st">"eageg"</span>,<span class="st">"cohort1"</span>,<span class="st">"cohort2"</span>,<span class="st">"edtert1"</span>,<span class="st">"edtert2"</span>,<span class="st">"systm"</span>,<span class="st">"diastm"</span>,<span class="st">"chola"</span>,<span class="st">"hdla"</span><span class="op">)</span>
    <span class="va">monica</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.fwf.html">read.fwf</a></span><span class="op">(</span><span class="st">"data/form04_3.txt"</span>, widths <span class="op">=</span> <span class="va">widths</span>, col.names <span class="op">=</span> <span class="va">colnames</span><span class="op">)</span>

    <span class="va">age_structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv2</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data/vaesto_3112_2017.csv"</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">sex</span> <span class="op">&lt;-</span> <span class="fu">rbin</span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
    <span class="va">mf</span> <span class="op">&lt;-</span> <span class="va">age_structure</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> 
    <span class="va">age_structure</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mf</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">mf</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/col.html">col</a></span><span class="op">(</span><span class="va">mf</span><span class="op">)</span><span class="op">]</span>
    <span class="va">age</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">30</span><span class="op">:</span><span class="fl">99</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="va">age_structure</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span>
           <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">30</span><span class="op">:</span><span class="fl">99</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="va">age_structure</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>
    <span class="va">smoking</span> <span class="op">&lt;-</span> <span class="fu">sex_age_init</span><span class="op">(</span><span class="va">n</span>, <span class="va">sex</span>, <span class="va">age</span>, 
                            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.319</span>, <span class="fl">0.298</span>, <span class="fl">0.278</span>, <span class="fl">0.219</span>, <span class="fl">0.109</span>, <span class="fl">0.016</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.229</span>, <span class="fl">0.193</span>, <span class="fl">0.184</span>, <span class="fl">0.147</span>, <span class="fl">0.054</span>, <span class="fl">0.016</span><span class="op">)</span>, <span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span>

    <span class="va">parent_stroke</span> <span class="op">&lt;-</span> <span class="fu">rbin</span><span class="op">(</span><span class="va">n</span>, prob <span class="op">=</span> <span class="fl">0.127</span><span class="op">)</span>
    <span class="va">high_glucose</span> <span class="op">&lt;-</span> <span class="fu">sex_age_init</span><span class="op">(</span><span class="va">n</span>, <span class="va">sex</span>, <span class="va">age</span>, 
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.013</span>, <span class="fl">0.043</span>, <span class="fl">0.080</span>, <span class="fl">0.114</span>, <span class="fl">0.128</span>, <span class="fl">0.110</span><span class="op">)</span>, 
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.019</span>, <span class="fl">0.012</span>, <span class="fl">0.030</span>, <span class="fl">0.055</span>, <span class="fl">0.121</span>, <span class="fl">0.093</span><span class="op">)</span>, <span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span>
    <span class="va">stroke</span> <span class="op">&lt;-</span> <span class="fu">sex_age_init</span><span class="op">(</span><span class="va">n</span>, <span class="va">sex</span>, <span class="va">age</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.027</span>, <span class="fl">0.063</span>, <span class="fl">0.091</span>, <span class="fl">0.163</span><span class="op">)</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.013</span>, <span class="fl">0.029</span>, <span class="fl">0.061</span>, <span class="fl">0.137</span><span class="op">)</span>, <span class="fl">50</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span>
    <span class="va">age_at_stroke</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="va">n</span><span class="op">)</span>
    <span class="va">age_at_stroke</span><span class="op">[</span><span class="va">stroke</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span><span class="op">[</span><span class="va">stroke</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">]</span> <span class="op">-</span> 
        <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html">rweibull</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">stroke</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">0.509246</span>, scale <span class="op">=</span> <span class="fl">1634.480968</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365.0</span>, <span class="fl">30</span><span class="op">)</span>

    <span class="co"># decoding missing values</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">height</span><span class="op">[</span><span class="va">monica</span><span class="op">$</span><span class="va">height</span> <span class="op">==</span> <span class="fl">999</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">weight</span><span class="op">[</span><span class="va">monica</span><span class="op">$</span><span class="va">weight</span> <span class="op">==</span> <span class="fl">9999</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">waist</span><span class="op">[</span><span class="va">monica</span><span class="op">$</span><span class="va">waist</span> <span class="op">==</span> <span class="fl">9999</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">systm</span><span class="op">[</span><span class="va">monica</span><span class="op">$</span><span class="va">systm</span> <span class="op">==</span> <span class="fl">9999</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">chol</span><span class="op">[</span><span class="va">monica</span><span class="op">$</span><span class="va">chol</span> <span class="op">&gt;=</span> <span class="fl">888</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">hdl</span><span class="op">[</span><span class="va">monica</span><span class="op">$</span><span class="va">hdl</span> <span class="op">&gt;=</span> <span class="fl">777</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>

    <span class="co"># unit transformations</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">weight</span> <span class="op">/</span> <span class="fl">10</span> <span class="co"># transform to kg</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">waist</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">waist</span> <span class="op">/</span> <span class="fl">10</span> <span class="co"># transform to cm</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">systm</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">systm</span> <span class="op">/</span> <span class="fl">10</span> <span class="co"># transform to mmHg</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">chol</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">chol</span> <span class="op">/</span> <span class="fl">10</span> <span class="co"># transform to mmol/l</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">hdl</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">hdl</span> <span class="op">/</span> <span class="fl">100</span> <span class="co"># transform to mmol/l</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">bmi</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">weight</span> <span class="op">/</span> <span class="op">(</span><span class="va">monica</span><span class="op">$</span><span class="va">height</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">sex</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">$</span><span class="va">sex</span> <span class="op">-</span> <span class="fl">1</span> <span class="co"># female = 1</span>
    <span class="co">#monica$smoking &lt;- 0 + (monica$cigs %in% c(1,3))</span>
    <span class="va">monica</span><span class="op">$</span><span class="va">smoking</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="op">+</span> <span class="op">(</span><span class="va">monica</span><span class="op">$</span><span class="va">cigs</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">|</span> 
                           <span class="va">monica</span><span class="op">$</span><span class="va">cigarsm</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">|</span> 
                           <span class="va">monica</span><span class="op">$</span><span class="va">pipesm</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>

    <span class="va">selcol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bmi"</span>, <span class="st">"waist"</span>, <span class="st">"chol"</span>, <span class="st">"hdl"</span>, <span class="st">"systm"</span><span class="op">)</span>
    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">selcol</span><span class="op">)</span>
    <span class="va">monica2</span> <span class="op">&lt;-</span> <span class="va">monica</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"eage"</span>, <span class="st">"sex"</span>, <span class="st">"smoking"</span>, <span class="va">selcol</span><span class="op">)</span><span class="op">]</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">monica2</span><span class="op">$</span><span class="va">waist</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">monica2</span><span class="op">$</span><span class="va">chol</span><span class="op">)</span><span class="op">)</span>
    <span class="va">monica2</span> <span class="op">&lt;-</span> <span class="va">monica2</span><span class="op">[</span><span class="op">-</span><span class="va">out</span>,<span class="op">]</span>
    <span class="va">monica2</span><span class="op">$</span><span class="va">agegr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">monica2</span><span class="op">$</span><span class="va">eage</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span><span class="op">)</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

    <span class="co"># Generate initial values in each subgroup of sex, smoking and age</span>
    <span class="va">norm_grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, smoking <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, agegr <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
    <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">norm_grp</span><span class="op">)</span>
    <span class="va">norm_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
    <span class="va">norm_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="va">k</span><span class="op">)</span>

    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">monica2</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="va">norm_grp</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> 
                <span class="va">monica2</span><span class="op">$</span><span class="va">smoking</span> <span class="op">==</span> <span class="va">norm_grp</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">monica2</span><span class="op">$</span><span class="va">agegr</span><span class="op">)</span> <span class="op">==</span> <span class="va">norm_grp</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>
        <span class="va">ind</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
        <span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
        <span class="va">norm_dat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span>, <span class="va">m</span><span class="op">)</span>
        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">bc</span> <span class="op">&lt;-</span> <span class="fu">bestNormalize</span><span class="fu">::</span><span class="fu"><a href="https://petersonr.github.io/bestNormalize/reference/boxcox.html">boxcox</a></span><span class="op">(</span><span class="va">monica2</span><span class="op">[</span><span class="va">ind</span>,<span class="va">selcol</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
            <span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">trans</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bc</span>
            <span class="va">norm_dat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="va">x.t</span>
        <span class="op">}</span>
        <span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">norm_dat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">norm_dat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, use <span class="op">=</span> <span class="st">"complete.obs"</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">m</span><span class="op">)</span>

    <span class="va">age_mon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">age</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">100</span><span class="op">)</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">5</span><span class="op">:</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="va">norm_grp</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span>
                <span class="va">smoking</span> <span class="op">==</span> <span class="va">norm_grp</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> 
                <span class="va">age_mon</span> <span class="op">==</span> <span class="va">norm_grp</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>
        <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span>, mu <span class="op">=</span> <span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span>, Sigma <span class="op">=</span> <span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Sigma</span><span class="op">)</span>
        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">temp</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">norm_par</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">trans</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>, <span class="va">temp</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="op">}</span>
        <span class="va">X</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">temp</span>
    <span class="op">}</span>

    <span class="co"># Limits data to values that have been actually observed</span>
    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">impose_limits</span><span class="op">(</span><span class="va">X</span>, <span class="va">sex</span>, <span class="va">smoking</span>, <span class="va">age_mon</span>, 
                       <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">72.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">152</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">11.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.37</span>, <span class="fl">3.62</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">78</span>, <span class="fl">252</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

    <span class="va">bmi</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
    <span class="va">waist_circumference</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>
    <span class="va">cholesterol</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>
    <span class="va">hdl_cholesterol</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>
    <span class="va">blood_pressure</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>

    <span class="co"># Generating diabetes status based on FINDRISC risk score</span>
    <span class="va">diabetes_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5.514</span>, <span class="fl">0.628</span>, <span class="fl">0.892</span>, <span class="fl">0.165</span>, <span class="fl">1.096</span>, <span class="fl">0.857</span>, <span class="fl">1.350</span>, <span class="fl">2.139</span><span class="op">)</span>
    <span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="fl">8</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">45</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;</span> <span class="fl">54</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">54</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bmi</span> <span class="op">&gt;</span> <span class="fl">25</span> <span class="op">&amp;</span> <span class="va">bmi</span> <span class="op">&lt;=</span> <span class="fl">30</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bmi</span> <span class="op">&gt;</span> <span class="fl">30</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">94</span> <span class="op">&amp;</span> <span class="va">waist_circumference</span> <span class="op">&lt;</span> <span class="fl">102</span><span class="op">)</span> <span class="op">+</span>
             <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">80</span> <span class="op">&amp;</span> <span class="va">waist_circumference</span> <span class="op">&lt;</span> <span class="fl">88</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">102</span><span class="op">)</span> <span class="op">+</span> 
             <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">waist_circumference</span> <span class="op">&gt;=</span> <span class="fl">88</span><span class="op">)</span>
    <span class="va">D</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">high_glucose</span>
    <span class="va">diabetes_risk</span> <span class="op">&lt;-</span> <span class="fu">expit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">D</span> <span class="op">%*%</span> <span class="va">diabetes_par</span><span class="op">)</span><span class="op">)</span>
    <span class="va">diabetes_risk</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">diabetes_risk</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">diabetes_risk</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.15</span>
    <span class="va">diabetes_risk</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">diabetes_risk</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">diabetes_risk</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.10</span>
    <span class="va">diabetes</span> <span class="op">&lt;-</span> <span class="fu">rbern</span><span class="op">(</span><span class="va">diabetes_risk</span><span class="op">)</span>

    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
        alive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="va">n</span><span class="op">)</span>,
        age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>,
        age_at_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>,
        age_at_stroke <span class="op">=</span> <span class="va">age_at_stroke</span>,
        sex <span class="op">=</span> <span class="va">sex</span>,
        smoking <span class="op">=</span> <span class="va">smoking</span>,
        diabetes <span class="op">=</span> <span class="va">diabetes</span>,
        parent_stroke <span class="op">=</span> <span class="va">parent_stroke</span>,
        high_glucose <span class="op">=</span> <span class="va">high_glucose</span>,
        stroke <span class="op">=</span> <span class="va">stroke</span>,
        bmi <span class="op">=</span> <span class="va">bmi</span>,
        waist_circumference <span class="op">=</span> <span class="va">waist_circumference</span>,
        cholesterol <span class="op">=</span> <span class="va">cholesterol</span>,
        hdl_cholesterol <span class="op">=</span> <span class="va">hdl_cholesterol</span>,
        blood_pressure <span class="op">=</span> <span class="va">blood_pressure</span>,
        cause_of_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="va">n</span><span class="op">)</span>,
        id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>
    <span class="op">)</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
</div>
<div id="utility-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#utility-functions" class="anchor"></a>Utility functions</h2>
<p>The file <code>functions.R</code> provides a set of useful functions used in defining events and the initial data</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Bernoulli distribution with probability of success (1) 'prob' (vectorized over prob)</span>
<span class="va">rbern</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prob</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">1L</span> <span class="op">*</span> <span class="op">(</span><span class="fu">dqrng</span><span class="fu">::</span><span class="fu"><a href="https://daqana.github.io/dqrng/reference/dqrng-functions.html">dqrunif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## Bernoulli distribution for 'n' repetitions with the same probability 'prob'</span>
<span class="va">rbern2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">prob</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">1L</span> <span class="op">*</span> <span class="op">(</span><span class="fu">dqrng</span><span class="fu">::</span><span class="fu"><a href="https://daqana.github.io/dqrng/reference/dqrng-functions.html">dqrunif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## Uniformly random date between 'start' and 'end' dates (inclusive)</span>
<span class="va">rdate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">end</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## Random binary, where the probability of 1 is 'prob'</span>
<span class="va">rbin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">size</span>, <span class="va">prob</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="fl">1L</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">size</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">prob</span>, <span class="va">prob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## The logistic link function</span>
<span class="va">logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span>

<span class="co">## Inverse logistic link</span>
<span class="va">expit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="co">## Function to generate binary starting values based on age-based proportions</span>
<span class="co">## n        : number of values to generate</span>
<span class="co">## sex      : vector of sex for each individual</span>
<span class="co">## age      : vector of ages (in years)</span>
<span class="co">## val_m    : proportions for males in each age group</span>
<span class="co">## val_f    : proportions for females in each age group</span>
<span class="co">## age_min  : youngest age group, no individual should have an age below this</span>
<span class="co">## age_max  : oldest distinct age group, ages above this are considered a single group</span>
<span class="co">## age_step : size of each age group</span>
<span class="va">sex_age_init</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">sex</span>, <span class="va">age</span>, <span class="va">val_m</span>, <span class="va">val_f</span>, <span class="va">age_min</span>, <span class="va">age_max</span>, <span class="va">age_step</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">groups</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">age_max</span> <span class="op">-</span> <span class="va">age_min</span><span class="op">)</span> <span class="op">%/%</span> <span class="va">age_step</span> <span class="op">+</span> <span class="fl">1</span>
    <span class="va">age_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="va">age_min</span><span class="op">)</span> <span class="op">%/%</span> <span class="va">age_step</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">groups</span><span class="op">)</span>
    <span class="va">age_group</span><span class="op">[</span><span class="va">age_group</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">age_group</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">val_m</span><span class="op">[</span><span class="va">age_group</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">val_f</span><span class="op">[</span><span class="va">age_group</span><span class="op">]</span><span class="op">)</span>
    <span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">p</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## Function to resample values within an allowed range</span>
<span class="co">## X       : a matrix of values</span>
<span class="co">## sex     : a vector of sex indicators</span>
<span class="co">## smoking : a vector of smoking indicators</span>
<span class="co">## age     : a vector of age groups</span>
<span class="co">## limits  : a list of allowed ranges for column of 'X'</span>
<span class="va">impose_limits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">sex</span>, <span class="va">smoking</span>, <span class="va">age</span>, <span class="va">limits</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>
    <span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">smoking</span><span class="op">)</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">g</span> <span class="op">&lt;-</span> <span class="va">sex</span> <span class="op">==</span> <span class="va">groups</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">smoking</span> <span class="op">==</span> <span class="va">groups</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">==</span> <span class="va">groups</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span>
        <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
            <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">g</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">limits</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">|</span> <span class="va">X</span><span class="op">[</span><span class="va">g</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">limits</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
            <span class="va">bound</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="va">out</span>
            <span class="va">g_out</span> <span class="op">&lt;-</span> <span class="va">g</span>
            <span class="va">g_out</span><span class="op">[</span><span class="va">g</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">out</span>
            <span class="va">g_bound</span> <span class="op">&lt;-</span> <span class="va">g</span>
            <span class="va">g_bound</span><span class="op">[</span><span class="va">g</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="va">out</span>
            <span class="va">X</span><span class="op">[</span><span class="va">g_out</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">g_bound</span>,<span class="va">j</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="op">}</span>
    <span class="op">}</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## Objective function to calibrate total mortality to mortality of the Finnish population</span>
<span class="co">## x : current vector of parameter values</span>
<span class="va">mortality_objective</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">calib_sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">mortality</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data/kuol_007_201700.csv"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span>
    <span class="va">mortality</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mortality</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">/</span><span class="fl">1000</span>
    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mortality</span><span class="op">)</span>
    <span class="co"># Impute 100-year-olds from 99</span>
    <span class="va">mortality</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span><span class="op">(</span><span class="va">mortality</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">2017</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">mortality</span><span class="op">[</span><span class="va">n</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">mortality</span><span class="op">[</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> 
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Other Mortality"</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span>, <span class="st">"Stroke Mortality"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
    <span class="va">calib_res</span> <span class="op">&lt;-</span> <span class="va">calib_sim</span><span class="op">$</span><span class="fu">configure</span><span class="op">(</span>t_sim <span class="op">=</span> <span class="fl">364</span>, p <span class="op">=</span> <span class="va">p</span>, output <span class="op">=</span> <span class="va">mortality_df</span>, min_age <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">calib_res</span><span class="op">$</span><span class="va">out</span>
    <span class="va">stroke_prop</span> <span class="op">&lt;-</span> <span class="va">calib_res</span><span class="op">$</span><span class="va">stroke_prop</span>
    <span class="va">s_obj</span> <span class="op">&lt;-</span> <span class="fl">1e7</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">stroke_prop</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">s_obj</span> <span class="op">&lt;-</span> <span class="fl">2000</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">stroke_prop</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0.07534936</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
    <span class="va">mortality</span> <span class="op">&lt;-</span> <span class="va">mortality</span><span class="op">[</span><span class="va">mortality</span><span class="op">$</span><span class="va">Age</span> <span class="op">%in%</span> <span class="va">out</span><span class="op">$</span><span class="va">age_group</span>,<span class="op">]</span>
    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span>
    <span class="va">w</span><span class="op">[</span><span class="va">out</span><span class="op">$</span><span class="va">age_group</span> <span class="op">&gt;=</span> <span class="fl">80</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># Weight for mortalities &gt;= 60, fit should be better here</span>
    <span class="va">valid</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">out</span><span class="op">[</span> ,<span class="fl">2</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">out</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="va">out</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">out</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>
    <span class="va">all_dead</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="va">out</span><span class="op">[</span> ,<span class="fl">2</span><span class="op">]</span>
    <span class="va">all_alive</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span>
    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">valid</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">mortality</span><span class="op">[</span><span class="va">valid</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span><span class="va">valid</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="va">out</span><span class="op">[</span><span class="va">valid</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">obj</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">all_dead</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">mortality</span><span class="op">[</span><span class="va">all_dead</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">obj</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">all_alive</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">mortality</span><span class="op">[</span><span class="va">all_alive</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">obj</span> <span class="op">+</span> <span class="va">s_obj</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## A function used to calibrate total mortality</span>
<span class="co">## dt        : the status data.table</span>
<span class="co">## min_age   : the youngest age group</span>
<span class="va">mortality_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">min_age</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">dt</span><span class="op">[</span> ,<span class="va">age_group</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">]</span>
    <span class="va">deaths</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">.N</span>, by <span class="op">=</span> <span class="va">age_group</span><span class="op">]</span>
    <span class="va">size</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span> , <span class="va">.N</span>, by <span class="op">=</span> <span class="va">age_group</span><span class="op">]</span>
    <span class="va">groups</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">age_group</span><span class="op">)</span>
    <span class="va">ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ages</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ages</span><span class="op">)</span>, age_group <span class="op">=</span> <span class="va">groups</span><span class="op">)</span>
    <span class="va">out</span><span class="op">[</span><span class="va">size</span><span class="op">$</span><span class="va">age_group</span> <span class="op">+</span> <span class="fl">1</span>,<span class="st">"size"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">size</span><span class="op">$</span><span class="va">N</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">$</span><span class="va">N</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">out</span><span class="op">[</span><span class="va">deaths</span><span class="op">$</span><span class="va">age_group</span> <span class="op">+</span> <span class="fl">1</span>,<span class="st">"deaths"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">deaths</span><span class="op">$</span><span class="va">N</span>
    <span class="op">}</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="va">out</span><span class="op">$</span><span class="va">age_group</span> <span class="op">&gt;=</span> <span class="va">min_age</span>, <span class="op">]</span>
    <span class="va">stroke_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">stroke</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> 
                               <span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="va">age_at_stroke</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="fl">28</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt</span><span class="op">[</span><span class="va">alive</span> <span class="op">==</span> <span class="fl">0</span>,<span class="op">]</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">out</span>, stroke_prop <span class="op">=</span> <span class="va">stroke_prop</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Santtu Tikka, Jussi Hakanen, Mirka Saarela, Juha Karvanen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
